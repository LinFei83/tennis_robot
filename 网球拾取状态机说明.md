# 网球拾取状态机功能说明

## 概述

本次更新为网球机器人添加了完整的自动拾取功能，实现了一个智能的状态机系统，能够自动搜索、追踪、接近、拾取网球，并在拾取完成后继续搜索其他网球。

## 主要改进

### 1. 智能球选择策略
- **原来**：选择距离屏幕中心最近的球
- **现在**：选择检测框最大的球（即最近的球），更符合实际拾取需求

### 2. 简化的拾取状态机

系统现在包含以下7个状态：

#### IDLE (空闲)
- 系统初始状态
- 拾取模式关闭时的状态

#### SEARCHING (搜索)
- 拾取模式开启后的初始状态
- 机器人保持静止，等待检测到网球
- 检测到球后自动转换到追踪状态

#### TRACKING (追踪)
- 使用PID控制器将检测到的最大球旋转到屏幕中央
- 球对准中心后转换到接近状态
- 球丢失时返回搜索状态
- 包含超时保护机制

#### APPROACHING (接近)
- 球已对准中心，机器人开始前进接近
- 持续监控球是否偏离中心，偏离时返回追踪状态
- **简化逻辑**：视野中没有球时立即认为拾取成功，转换到后退状态
- 包含超时保护机制

#### BACKING_UP (后退)
- 拾取完成后后退一定距离
- 为下一次搜索创造空间
- 后退完成后转换到360度搜索状态

#### ROTATING_SEARCH (360度搜索)
- 机器人原地旋转360度搜索周围的网球
- 发现新球时立即转换到追踪状态
- 完成一圈搜索后转换到完成状态

#### COMPLETED (完成)
- 所有网球拾取完成
- 机器人保持停止状态
- 用户可以手动重启拾取过程

## 技术特性

### 鲁棒性设计

1. **超时保护**
   - 每个状态都有相应的超时机制
   - 防止系统卡在某个状态

2. **错误恢复**
   - 球丢失时自动返回搜索状态
   - 异常情况下的状态重置

3. **实时监控**
   - 详细的状态信息显示
   - 实时的球检测数据反馈

### 参数可调节

- `pickup_timeout`: 拾取超时时间 (1.0-10.0秒)
- `backup_duration`: 后退持续时间 (0.5-5.0秒)
- `search_timeout`: 搜索超时时间 (5.0-30.0秒)
- `rotation_speed`: 搜索旋转速度 (0.1-1.0 rad/s)
- `forward_speed`: 前进速度 (0.1-1.0 m/s)

## 用户界面更新

### 新增控制按钮
- **紧急停止**: 立即停止所有运动并退出拾取模式
- **重启拾取**: 在拾取模式下重新开始搜索过程

### 状态显示更新
- **当前状态**: 显示状态机的当前状态
- **已拾取球数**: 显示已成功拾取的网球数量
- **球面积**: 显示当前目标球的检测框面积（用于判断接近程度）

### WebSocket事件
- `state_change`: 状态变化通知
- `pickup_status_update`: 拾取状态更新
- `emergency_stop`: 紧急停止通知

## 使用方法

### 基本操作流程

1. **启动系统**
   - 点击"启动机器人"按钮
   - 点击"启动视觉"按钮
   - 确保摄像头正常工作

2. **开始拾取**
   - 点击"开启拾取"按钮
   - 系统自动进入搜索状态
   - 观察状态显示面板了解当前进展

3. **监控过程**
   - 通过状态面板监控拾取进度
   - 观察"当前状态"了解机器人行为
   - 查看"已拾取球数"了解成果

4. **紧急情况**
   - 点击"紧急停止"立即停止所有动作
   - 点击"重启拾取"重新开始搜索

### 参数调节

可以通过Web界面调节各种参数来优化拾取性能：
- 根据实际环境调整超时时间
- 根据机器人性能调整运动速度

## 代码结构

### 核心模块

1. **BallController** (`web_modules/ball_controller.py`)
   - 网球检测和控制逻辑
   - 运动控制命令
   - 参数管理

2. **BallTracker** (`web_modules/ball_tracker.py`)
   - 状态机实现
   - 状态转换逻辑
   - WebSocket通信

3. **PickupControl** (`static/js/modules/PickupControl.js`)
   - 前端控制逻辑
   - 用户界面更新
   - 事件处理

## 注意事项

1. **安全性**
   - 始终保持对机器人的监控
   - 在紧急情况下使用紧急停止功能
   - 确保拾取区域安全

2. **环境要求**
   - 充足的光线条件
   - 相对平坦的地面
   - 足够的活动空间

3. **维护建议**
   - 定期清洁摄像头镜头
   - 检查拾取装置的工作状态
   - 根据使用情况调整参数

## 故障排除

### 常见问题

1. **机器人不前进**
   - 检查球是否已对准中心
   - 确认机器人控制器连接正常

2. **拾取不成功**
   - 调整拾取距离阈值
   - 检查拾取装置机械结构

3. **搜索不完整**
   - 增加搜索超时时间
   - 调整旋转速度

4. **状态卡死**
   - 使用紧急停止重置
   - 检查传感器连接

## 技术支持

如遇到问题，请检查：
1. 控制台日志信息
2. WebSocket连接状态
3. 机器人硬件连接
4. 摄像头工作状态

---

*此文档描述了网球拾取状态机的完整功能。系统设计注重实用性和鲁棒性，能够适应各种实际使用场景。*
